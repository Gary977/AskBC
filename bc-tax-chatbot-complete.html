<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BC Tax Website with AskBC Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-blue: #1E5091;
            --secondary-blue: #4B7FBD;
            --light-blue: #E8F2FF;
            --accent-yellow: #FDB813;
            --text-dark: #2C3E50;
            --text-gray: #6B7280;
            --white: #FFFFFF;
            --gray-light: #F5F7FA;
            --gray-border: #E1E8ED;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-strong: 0 5px 25px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--gray-light);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Demo Page Content */
        .demo-header {
            background: var(--primary-blue);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        /* Chatbot Input Bar */
        .chatbot-input-container {
            max-width: 800px;
            margin: -30px auto 2rem;
            position: relative;
            z-index: 100;
        }

        .chatbot-input-wrapper {
            background: white;
            border-radius: 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            padding: 8px;
            transition: all 0.3s ease;
        }

        .chatbot-input-wrapper:hover {
            box-shadow: 0 6px 30px rgba(0, 0, 0, 0.15);
        }

        /* 税务流程激活时的视觉提示 */
        .chatbot-input-wrapper.flow-active {
            background-color: var(--gray-light);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .chatbot-input-wrapper.flow-active .main-input-field::placeholder {
            color: #b0b0b0;
        }

        .chatbot-expand-btn {
            width: 56px;
            height: 56px;
            border-radius: 28px;
            background: var(--light-blue);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
            margin-right: 12px;
        }

        .chatbot-expand-btn:hover {
            background: var(--primary-blue);
            transform: scale(1.05);
        }

        .chatbot-expand-btn:hover .expand-icon {
            color: white;
        }

        .expand-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .main-input-field {
            flex: 1;
            border: none;
            outline: none;
            font-size: 18px;
            padding: 12px 0;
            color: var(--text-dark);
        }

        .main-input-field::placeholder {
            color: var(--text-gray);
        }

        /* 禁用状态的输入框 */
        .main-input-field:disabled {
            background-color: transparent;
            cursor: not-allowed;
            color: var(--text-gray);
        }

        .input-actions {
            display: flex;
            gap: 8px;
            margin-left: 12px;
        }

        .main-voice-btn,
        .main-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 22px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .main-voice-btn {
            background: var(--gray-light);
            color: var(--text-gray);
        }

        .main-voice-btn:hover {
            background: var(--gray-border);
        }

        .main-voice-btn.recording {
            background: #ef4444;
            color: white;
            animation: pulse-recording 1.5s infinite;
        }

        /* 禁用状态的按钮 */
        .main-voice-btn:disabled,
        .main-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .main-send-btn {
            background: var(--primary-blue);
            color: white;
        }

        .main-send-btn:hover {
            background: var(--secondary-blue);
        }

        @keyframes pulse-recording {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Expandable Chat Panel */
        .chat-panel {
            max-width: 800px;
            margin: 0 auto 2rem;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
        }

        .chat-panel.expanded {
            max-height: 600px;
            opacity: 1;
            margin-top: -10px;
        }

        .panel-header {
            background: white;
            padding: 20px;
            border-bottom: 1px solid var(--gray-border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
        }

        .panel-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .panel-avatar {
            width: 44px;
            height: 44px;
            background: var(--light-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-blue);
            font-size: 24px;
        }

        .panel-header-text h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 2px;
        }

        .panel-header-text p {
            font-size: 12px;
            color: var(--text-gray);
        }

        .panel-close {
            width: 36px;
            height: 36px;
            border: none;
            background: var(--gray-light);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: var(--text-gray);
            font-size: 24px;
            font-weight: 300;
            line-height: 1;
        }

        .panel-close:hover {
            background: var(--gray-border);
        }

        /* Chat Toolbar Styles */
        #chatToolbar {
            background: white;
            border-top: 1px solid var(--gray-border);
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 20;
            flex-shrink: 0;
        }

        #toolbarLeft,
        #toolbarRight {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Font Size Control */
        #fontControl {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fs-label {
            color: var(--text-gray);
            font-weight: 500;
            user-select: none;
        }

        .fs-label.sm {
            font-size: 12px;
        }

        .fs-label.lg {
            font-size: 20px;
        }

        #sliderBox {
            width: 80px;
            height: 20px;
            background: var(--gray-light);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            margin: 0 4px;
        }

        #sliderFill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: var(--primary-blue);
            border-radius: 10px;
            width: 33%;
            transition: width 0.2s ease;
        }

        #sliderHandle {
            position: absolute;
            top: 50%;
            left: 33%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            background: white;
            border: 2px solid var(--primary-blue);
            border-radius: 50%;
            cursor: grab;
            transition: left 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #sliderHandle:active {
            cursor: grabbing;
        }

        /* Toolbar Buttons */
        .tb-btn {
            width: 36px;
            height: 36px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-gray);
            transition: all 0.2s;
        }

        .tb-btn:hover {
            background: var(--gray-light);
            color: var(--primary-blue);
        }

        .tb-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Divider */
        .tb-divider {
            width: 1px;
            height: 24px;
            background: var(--gray-border);
            margin: 0 4px;
        }

        /* End Chat Button */
        #endBtn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--gray-light);
            color: var(--text-gray);
            border: 1px solid var(--gray-border);
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        #endBtn:hover {
            background: white;
            border-color: var(--primary-blue);
            color: var(--primary-blue);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #endBtn svg {
            width: 16px;
            height: 16px;
        }

        /* 禁用状态的End Chat按钮 */
        #endBtn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Hide toolbar in home view */
        .panel-content:not(.chat-active) #chatToolbar {
            display: none;
        }

        /* 在home view时禁用End Chat按钮 */
        .panel-content:not(.chat-active) #endBtn {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Panel Content Areas */
        .panel-content {
            flex: 1;
            overflow-y: auto;
            position: relative;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
        }

        /* Chat Messages Container Position */
        .chat-messages {
            display: none;
            padding: 20px;
            background: var(--gray-light);
            flex: 1;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* Home View */
        .home-view {
            display: block;
            flex: 1;
            overflow-y: auto;
        }

        .panel-content.chat-active .home-view {
            display: none;
        }

        .panel-content.chat-active .chat-messages {
            display: block;
        }

        /* Welcome Section */
        .welcome-section {
            padding: 24px;
            background: var(--gray-light);
            text-align: center;
        }

        .welcome-wave {
            font-size: 48px;
            margin-bottom: 16px;
            animation: wave 1s ease-in-out;
        }

        @keyframes wave {
            0%, 100% {
                transform: rotate(0deg);
            }
            25% {
                transform: rotate(20deg);
            }
            75% {
                transform: rotate(-20deg);
            }
        }

        .welcome-title {
            font-size: 20px;
            color: var(--text-dark);
            margin-bottom: 8px;
        }

        /* Quick Actions Grid */
        .quick-actions-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 20px;
        }

        .action-card {
            background: white;
            border: 2px solid var(--gray-border);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-card:hover {
            border-color: var(--primary-blue);
            box-shadow: 0 4px 12px rgba(30, 80, 145, 0.1);
            transform: translateY(-2px);
        }

        .action-icon {
            width: 40px;
            height: 40px;
            background: var(--light-blue);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-size: 20px;
            color: var(--primary-blue);
        }

        .action-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-dark);
            line-height: 1.2;
        }

        /* Message styles */
        .message {
            margin-bottom: 16px;
            display: flex;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 15px;
            line-height: 1.5;
        }

        .message.bot .message-bubble {
            background: white;
            color: var(--text-dark);
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .message.user .message-bubble {
            background: var(--primary-blue);
            color: white;
            border-bottom-right-radius: 4px;
        }

        /* Message Options */
        .message-options {
            margin-top: 12px;
        }

        .option-button {
            display: block;
            width: 100%;
            padding: 10px 16px;
            margin-top: 8px;
            background: var(--light-blue);
            color: var(--primary-blue);
            border: 1px solid var(--primary-blue);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            text-align: left;
        }

        .option-button:hover {
            background: var(--primary-blue);
            color: white;
        }

        .option-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Links in Messages */
        .message-bubble a {
            color: var(--secondary-blue);
            text-decoration: underline;
        }

        .message.user .message-bubble a {
            color: var(--light-blue);
        }

        /* Save Dialog */
        .save-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .save-dialog-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .save-dialog {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .save-dialog-overlay.show .save-dialog {
            transform: scale(1);
        }

        .save-dialog h3 {
            color: var(--primary-blue);
            margin-bottom: 12px;
            font-size: 20px;
        }

        .save-dialog p {
            color: var(--text-gray);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .save-dialog-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .save-dialog-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.2s;
        }

        .save-dialog-btn.primary {
            background: var(--primary-blue);
            color: white;
        }

        .save-dialog-btn.primary:hover {
            background: var(--secondary-blue);
        }

        .save-dialog-btn.secondary {
            background: var(--gray-light);
            color: var(--text-gray);
        }

        .save-dialog-btn.secondary:hover {
            background: var(--gray-border);
        }

        /* Font size variations */
        .font-size-small {
            font-size: 14px;
        }

        .font-size-small .message-bubble {
            font-size: 14px;
            line-height: 1.5;
        }

        .font-size-small .option-button {
            font-size: 13px;
            padding: 8px 14px;
        }

        .font-size-small .welcome-title {
            font-size: 18px;
        }

        .font-size-small .action-title {
            font-size: 12px;
        }

        .font-size-medium {
            font-size: 16px;
        }

        .font-size-medium .message-bubble {
            font-size: 16px;
            line-height: 1.6;
        }

        .font-size-medium .option-button {
            font-size: 14px;
            padding: 10px 16px;
        }

        .font-size-medium .welcome-title {
            font-size: 20px;
        }

        .font-size-medium .action-title {
            font-size: 13px;
        }

        .font-size-large {
            font-size: 18px;
        }

        .font-size-large .message-bubble {
            font-size: 18px;
            line-height: 1.7;
        }

        .font-size-large .option-button {
            font-size: 16px;
            padding: 12px 18px;
        }

        .font-size-large .welcome-title {
            font-size: 22px;
        }

        .font-size-large .action-title {
            font-size: 14px;
        }

        .font-size-xlarge {
            font-size: 20px;
        }

        .font-size-xlarge .message-bubble {
            font-size: 20px;
            line-height: 1.8;
            padding: 14px 18px;
        }

        .font-size-xlarge .option-button {
            font-size: 18px;
            padding: 14px 20px;
        }

        .font-size-xlarge .welcome-title {
            font-size: 24px;
        }

        .font-size-xlarge .action-title {
            font-size: 16px;
        }

        .font-size-xlarge .panel-header-text h3 {
            font-size: 20px;
        }

        .font-size-xlarge .panel-header-text p {
            font-size: 14px;
        }

        /* Demo Content */
        .demo-content {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }

        .demo-content h2 {
            color: var(--primary-blue);
            margin-bottom: 1rem;
        }

        .demo-content p {
            margin-bottom: 1rem;
            color: #666;
        }

        /* Filing Form Styles */
        .filing-form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .filing-form-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }

        .filing-form-container {
            background: white;
            border-radius: 20px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .filing-form-overlay.show .filing-form-container {
            transform: scale(1);
        }

        .filing-form-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .filing-form-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .filing-form-title {
            font-size: 24px;
            color: var(--primary-blue);
            margin-bottom: 8px;
        }

        .filing-form-subtitle {
            color: var(--text-gray);
            font-size: 16px;
        }

        .form-section {
            margin-bottom: 24px;
        }

        .form-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 6px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--gray-border);
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.2s;
            background-color: white;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(30, 80, 145, 0.1);
        }

        .form-checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .form-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .form-checkbox-label {
            font-size: 15px;
            color: var(--text-dark);
            cursor: pointer;
            user-select: none;
        }

        .form-radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .form-radio-item {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        .form-radio {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-radio-label {
            font-size: 15px;
            color: var(--text-dark);
            cursor: pointer;
            user-select: none;
        }

        .form-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 32px;
        }

        .form-btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .form-btn.primary {
            background: var(--primary-blue);
            color: white;
        }

        .form-btn.primary:hover {
            background: var(--secondary-blue);
        }

        .form-btn.secondary {
            background: white;
            color: var(--text-gray);
            border: 2px solid var(--gray-border);
        }

        .form-btn.secondary:hover {
            background: var(--gray-light);
        }

        .form-helper-text {
            font-size: 13px;
            color: var(--text-gray);
            margin-top: 4px;
        }

        /* Privacy Acknowledgement Styles */
        .privacy-notice {
            background: var(--light-blue);
            border: 1px solid var(--primary-blue);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .privacy-notice-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary-blue);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .privacy-notice-content {
            font-size: 14px;
            color: var(--text-dark);
            line-height: 1.6;
            margin-bottom: 16px;
        }

        .privacy-notice-content ul {
            margin: 12px 0;
            padding-left: 24px;
        }

        .privacy-notice-content li {
            margin-bottom: 8px;
        }

        .privacy-checkbox-container {
            background: white;
            border-radius: 8px;
            padding: 16px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            cursor: pointer;
        }

        .privacy-checkbox {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
            margin-top: 2px;
            cursor: pointer;
        }

        .privacy-checkbox-label {
            font-size: 15px;
            color: var(--text-dark);
            cursor: pointer;
            user-select: none;
            flex: 1;
        }

        .privacy-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chatbot-input-container {
                margin: -30px 20px 2rem;
            }

            .chat-panel {
                margin: 0 20px 2rem;
            }

            .quick-actions-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .main-input-field {
                font-size: 16px;
            }

            #chatToolbar {
                padding: 10px 16px;
                flex-wrap: wrap;
                gap: 10px;
            }

            #toolbarLeft,
            #toolbarRight {
                flex-wrap: wrap;
            }

            #sliderBox {
                width: 60px;
            }

            .tb-btn {
                width: 32px;
                height: 32px;
            }

            .tb-btn svg {
                width: 18px;
                height: 18px;
            }
        }

        @media (max-width: 480px) {
            .quick-actions-grid {
                grid-template-columns: 1fr;
            }

            #fontControl .fs-label {
                display: none;
            }

            #sliderBox {
                width: 80px;
            }

            #endBtn span {
                display: none;
            }

            #endBtn {
                padding: 8px;
                width: 36px;
                height: 36px;
                border-radius: 50%;
            }
        }
    </style>
</head>

<body>
    <!-- Demo Page Content -->
    <header class="demo-header">
        <h1>BC Taxes and Tax Credits</h1>
        <p>Province of British Columbia</p>
    </header>

    <!-- Chatbot Input Bar -->
    <div class="chatbot-input-container">
        <div class="chatbot-input-wrapper">
            <button class="chatbot-expand-btn" id="expandBtn">
                <div class="expand-icon">🤖</div>
            </button>
            <input type="text" class="main-input-field" id="mainInputField"
                placeholder="Ask me about BC taxes, benefits, or credits...">
            <div class="input-actions">
                <button class="main-voice-btn" id="mainVoiceBtn">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z" />
                        <path
                            d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z" />
                    </svg>
                </button>
                <button class="main-send-btn" id="mainSendBtn">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Expandable Chat Panel -->
    <div class="chat-panel" id="chatPanel">
        <div class="panel-header">
            <div class="panel-header-left">
                <div class="panel-header-info">
                    <div class="panel-avatar">🤖</div>
                    <div class="panel-header-text">
                        <h3>AskBC</h3>
                        <p>Your tax assistant</p>
                    </div>
                </div>
            </div>
            <button class="panel-close" id="panelCloseBtn">−</button>
        </div>

        <div class="panel-content" id="panelContent">
            <!-- Home View -->
            <div class="home-view">
                <div class="welcome-section">
                    <div class="welcome-wave">👋</div>
                    <h2 class="welcome-title">Hello! What would you like to do today?</h2>
                </div>

                <div class="quick-actions-grid">
                    <div class="action-card">
                        <div class="action-icon">📄</div>
                        <div class="action-title">Pay Property Tax</div>
                    </div>
                    <div class="action-card">
                        <div class="action-icon">📁</div>
                        <div class="action-title">View Tax Bill</div>
                    </div>
                    <div class="action-card">
                        <div class="action-icon">🔒</div>
                        <div class="action-title">Log in to eTaxBC</div>
                    </div>
                    <div class="action-card">
                        <div class="action-icon">📅</div>
                        <div class="action-title">Check Due Date</div>
                    </div>
                </div>

                <div style="padding: 20px;">
                    <h3 style="color: var(--primary-blue); margin-bottom: 10px;">Popular Topics</h3>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button
                            style="text-align: left; padding: 12px; background: var(--gray-light); border: none; border-radius: 8px; cursor: pointer;">
                            🏠 Homeowner Grant
                        </button>
                        <button
                            style="text-align: left; padding: 12px; background: var(--gray-light); border: none; border-radius: 8px; cursor: pointer;">
                            💰 Tax Deferment Program
                        </button>
                        <button
                            style="text-align: left; padding: 12px; background: var(--gray-light); border: none; border-radius: 8px; cursor: pointer;">
                            📊 Assessment Information
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Messages (Hidden initially) -->
            <div class="chat-messages" id="chatMessages"></div>
        </div>

        <!-- Bottom Toolbar -->
        <div id="chatToolbar">
            <div id="toolbarLeft">
                <!-- Font Size Control -->
                <div id="fontControl">
                    <span class="fs-label sm">A</span>
                    <div id="sliderBox">
                        <div id="sliderFill"></div>
                        <div id="sliderHandle"></div>
                    </div>
                    <span class="fs-label lg">A</span>
                </div>

                <div class="tb-divider"></div>

                <!-- Translate -->
                <button class="tb-btn" title="Translate">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z" />
                    </svg>
                </button>

                <!-- Print -->
                <button class="tb-btn" title="Print">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z" />
                    </svg>
                </button>

                <!-- Voice -->
                <button class="tb-btn" title="Voice assistant">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 15c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v7c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 15 6.7 12H5c0 3.42 2.72 6.23 6 6.72V22h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z" />
                    </svg>
                </button>

                <!-- Help -->
                <button class="tb-btn" title="Help">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z" />
                    </svg>
                </button>
            </div>

            <div id="toolbarRight">
                <!-- Download -->
                <button class="tb-btn" title="Download" id="downloadBtn">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z" />
                    </svg>
                </button>

                <!-- Share -->
                <button class="tb-btn" title="Share">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z" />
                    </svg>
                </button>

                <div class="tb-divider"></div>

                <!-- End Chat Button -->
                <button id="endBtn" class="disabled">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" />
                    </svg>
                    <span>End Chat</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Save Dialog -->
    <div class="save-dialog-overlay" id="saveDialogOverlay">
        <div class="save-dialog">
            <h3>Save Chat Transcript?</h3>
            <p>Would you like to download a copy of this conversation for your records? This can be helpful for future
                reference.</p>
            <div class="save-dialog-buttons">
                <button class="save-dialog-btn secondary" id="dontSaveBtn">No Thanks</button>
                <button class="save-dialog-btn primary" id="saveTranscriptBtn">Save Transcript</button>
            </div>
        </div>
    </div>

    <!-- Filing Form -->
    <div class="filing-form-overlay" id="filingFormOverlay">
        <div class="filing-form-container">
            <div class="filing-form-header">
                <div class="filing-form-icon">📋</div>
                <h2 class="filing-form-title">Tax Filing Information</h2>
                <p class="filing-form-subtitle">Let's personalize your tax filing experience</p>
            </div>

            <form id="filingForm">
                <div class="form-section">
                    <h3 class="form-section-title">
                        <span>📋</span> Information Collection Notice
                    </h3>
                    <div style="background: #f3f4f6; padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; color: #4b5563;">
                        The information you provide will only be used to customize your tax filing guidance during this session. 
                        Your data will not be stored or shared with third parties.
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <span>👤</span> Personal Information
                    </h3>
                    
                    <div class="form-group">
                        <label class="form-label" for="filingStatus">Filing Status</label>
                        <select class="form-select" id="filingStatus" name="filingStatus" required>
                            <option value="">Select your filing status</option>
                            <option value="single">Single</option>
                            <option value="married">Married/Common-law</option>
                            <option value="separated">Separated</option>
                            <option value="widowed">Widowed</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="province">Province of Residence</label>
                        <select class="form-select" id="province" name="province" required>
                            <option value="BC" selected>British Columbia</option>
                            <option value="AB">Alberta</option>
                            <option value="SK">Saskatchewan</option>
                            <option value="MB">Manitoba</option>
                            <option value="ON">Ontario</option>
                            <option value="QC">Quebec</option>
                            <option value="NB">New Brunswick</option>
                            <option value="NS">Nova Scotia</option>
                            <option value="PE">Prince Edward Island</option>
                            <option value="NL">Newfoundland and Labrador</option>
                            <option value="YT">Yukon</option>
                            <option value="NT">Northwest Territories</option>
                            <option value="NU">Nunavut</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">First time filing?</label>
                        <div class="form-radio-group">
                            <div class="form-radio-item">
                                <input type="radio" id="firstTimeYes" name="firstTime" value="yes" class="form-radio">
                                <label for="firstTimeYes" class="form-radio-label">Yes</label>
                            </div>
                            <div class="form-radio-item">
                                <input type="radio" id="firstTimeNo" name="firstTime" value="no" class="form-radio" checked>
                                <label for="firstTimeNo" class="form-radio-label">No</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Income Sources -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <span>💰</span> Income Sources
                    </h3>
                    <p class="form-helper-text" style="margin-bottom: 12px;">Select all that apply</p>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="incomeEmployment" name="incomeSources" value="employment" class="form-checkbox">
                        <label for="incomeEmployment" class="form-checkbox-label">Employment income (T4)</label>
                    </div>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="incomeSelfEmployed" name="incomeSources" value="selfEmployed" class="form-checkbox">
                        <label for="incomeSelfEmployed" class="form-checkbox-label">Self-employment/Business income</label>
                    </div>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="incomeInvestment" name="incomeSources" value="investment" class="form-checkbox">
                        <label for="incomeInvestment" class="form-checkbox-label">Investment income (T5)</label>
                    </div>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="incomeRental" name="incomeSources" value="rental" class="form-checkbox">
                        <label for="incomeRental" class="form-checkbox-label">Rental income</label>
                    </div>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="incomeBenefits" name="incomeSources" value="benefits" class="form-checkbox">
                        <label for="incomeBenefits" class="form-checkbox-label">Government benefits (EI, CPP, etc.)</label>
                    </div>

                    <div class="form-checkbox-group">
                        <input type="checkbox" id="incomeOther" name="incomeSources" value="other" class="form-checkbox">
                        <label for="incomeOther" class="form-checkbox-label">Other income sources</label>
                    </div>
                </div>

                <!-- Special Situations -->
                <div class="form-section">
                    <h3 class="form-section-title">
                        <span>⭐</span> Special Situations
                    </h3>
                    <p class="form-helper-text" style="margin-bottom: 12px;">Check any that apply to you</p>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="homeOwner" name="specialSituations" value="homeowner" class="form-checkbox">
                        <label for="homeOwner" class="form-checkbox-label">I own my home</label>
                    </div>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="hasChildren" name="specialSituations" value="children" class="form-checkbox">
                        <label for="hasChildren" class="form-checkbox-label">I have dependent children</label>
                    </div>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="student" name="specialSituations" value="student" class="form-checkbox">
                        <label for="student" class="form-checkbox-label">I'm a student or have tuition fees</label>
                    </div>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="medicalExpenses" name="specialSituations" value="medical" class="form-checkbox">
                        <label for="medicalExpenses" class="form-checkbox-label">I have significant medical expenses</label>
                    </div>
                    
                    <div class="form-checkbox-group">
                        <input type="checkbox" id="charitable" name="specialSituations" value="charitable" class="form-checkbox">
                        <label for="charitable" class="form-checkbox-label">I made charitable donations</label>
                    </div>
                </div>

                <div class="form-buttons">
                    <button type="button" class="form-btn secondary" onclick="closeFilingForm()">Cancel</button>
                    <button type="submit" class="form-btn primary">Start Customized Filing</button>
                </div>
            </form>
        </div>
    </div>

    <div class="demo-content">
        <h2>Welcome to BC Tax Services</h2>
        <p>Use the AskBC chatbot above to get help with your tax questions. You can type your question directly or click
            the smiley face to explore available options.</p>

        <h2>Available Services</h2>
        <ul>
            <li>Personal Income Tax Information</li>
            <li>Tax Credits and Benefits</li>
            <li>Renter's Tax Credit</li>
            <li>Family Benefits</li>
            <li>Climate Action Tax Credit</li>
        </ul>
    </div>

    <script>
        // State variables
        let isRecording = false;
        let isPanelExpanded = false;
        let inChatMode = false;
        let taxFlowActive = false;
        let taxFlowStep = 0;

        // 新增函数：控制输入控件的启用/禁用状态
        function setInputControlsEnabled(enabled) {
            const mainInput = document.getElementById('mainInputField');
            const voiceBtn = document.getElementById('mainVoiceBtn');
            const sendBtn = document.getElementById('mainSendBtn');
            const inputWrapper = document.querySelector('.chatbot-input-wrapper');
            
            if (enabled) {
                mainInput.disabled = false;
                voiceBtn.disabled = false;
                sendBtn.disabled = false;
                inputWrapper.classList.remove('flow-active');
                mainInput.placeholder = "Ask me about BC taxes, benefits, or credits...";
            } else {
                mainInput.disabled = true;
                voiceBtn.disabled = true;
                sendBtn.disabled = true;
                inputWrapper.classList.add('flow-active');
                mainInput.placeholder = "Please select an option below to continue...";
            }
        }

        // Tax flow conversation logic
        const taxFlowConversation = {
            start: () => {
                addMessage("Hi! I can help guide you through the tax filing process in BC. It can be a bit confusing, especially with both federal and provincial systems involved. Are you filing taxes for yourself this year?", 'bot', {
                    options: [
                        { text: "Yes, I'm filing for myself", action: "filing_self" },
                        { text: "No, I'm just browsing", action: "browsing" }
                    ]
                });
            },

            filing_self: () => {
                addMessage("Yes, I'm filing for myself", 'user');
                setTimeout(() => {
                    addMessage("Great! Let's walk through it together. Quick question: Have you already used a tool like Wealthsimple or TurboTax to prepare your tax documents?", 'bot', {
                        options: [
                            { text: "Yes, I used Wealthsimple", action: "used_wealthsimple" },
                            { text: "No, I haven't prepared them yet", action: "not_prepared" },
                            { text: "I'm not sure what that means", action: "not_sure" }
                        ]
                    });
                }, 800);
            },

            browsing: () => {
                addMessage("No, I'm just browsing", 'user');
                setTimeout(() => {
                    addMessage("No problem! Feel free to explore. I'm here if you need any help with BC tax information, benefits, or credits. Just let me know what you'd like to learn about!", 'bot');
                    // 重新启用输入控件
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            used_wealthsimple: () => {
                addMessage("Yes, I used Wealthsimple", 'user');
                setTimeout(() => {
                    addMessage(`Perfect — that means you already have your T1 tax return or similar files ready. Now let's talk about where to submit them.

Federal taxes (like income tax) go through the CRA website.
Provincial taxes (like property tax, PST) go through the BC government site.

Would you like me to give you direct links to both?`, 'bot', {
                        options: [
                            { text: "Yes, that would help", action: "show_links" },
                            { text: "No thanks, I know where to go", action: "know_where" }
                        ]
                    });
                }, 800);
            },

            not_prepared: () => {
                addMessage("No, I haven't prepared them yet", 'user');
                setTimeout(() => {
                    addMessage("That's okay! You'll need to gather your tax documents first (T4s, receipts, etc.) and use a tax preparation software. Would you like recommendations for free tax filing tools?", 'bot', {
                        options: [
                            { text: "Yes, show me options", action: "show_tools" },
                            { text: "I'll figure it out myself", action: "figure_out" }
                        ]
                    });
                }, 800);
            },

            not_sure: () => {
                addMessage("I'm not sure what that means", 'user');
                setTimeout(() => {
                    addMessage("No worries! Tax preparation tools like Wealthsimple Tax or TurboTax help you fill out your tax forms. They ask you questions and calculate everything for you. Would you like me to explain more about how to get started?", 'bot', {
                        options: [
                            { text: "Yes, please explain", action: "explain_tools" },
                            { text: "I'll research on my own", action: "research_own" }
                        ]
                    });
                }, 800);
            },

            show_links: () => {
                addMessage("Yes, that would help", 'user');
                setTimeout(() => {
                    addMessage(`Here you go:

<strong>CRA MyAccount</strong> (for federal tax): <a href="https://www.canada.ca/en/revenue-agency/services/e-services/e-services-individuals/account-individuals.html" target="_blank">cra.gc.ca/myaccount</a>

<strong>BC Tax Portal</strong> (for provincial tax like PST, property tax): <a href="https://www2.gov.bc.ca/gov/content/taxes" target="_blank">gov.bc.ca/revenue-services</a>

It's a bit split, I know! You're not alone — many people end up hiring an accountant just to make sense of this. But don't worry — we'll help you stay on track.`, 'bot');

                    setTimeout(() => {
                        addMessage("Want a step-by-step checklist of what to do next, based on your situation?", 'bot', {
                            options: [
                                { text: "Yes, please", action: "show_checklist" },
                                { text: "No, I'm good for now", action: "no_checklist" }
                            ]
                        });
                    }, 1500);
                }, 800);
            },

            know_where: () => {
                addMessage("No thanks, I know where to go", 'user');
                setTimeout(() => {
                    addMessage("Great! You seem well-prepared. Is there anything else about BC taxes or benefits you'd like to know about?", 'bot');
                    // 重新启用输入控件
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            show_checklist: () => {
                addMessage("Yes, please", 'user');
                setTimeout(() => {
                    const checklistHtml = `
                        <div class="tax-summary-card">
                            <h4>📋 Your Tax Filing Checklist</h4>
                            <ul>
                                <li><strong>Step 1</strong> – Use Wealthsimple or a certified tool to prepare your tax return</li>
                                <li><strong>Step 2</strong> – Log into CRA MyAccount and upload your return</li>
                                <li><strong>Step 3</strong> – Log into BC tax portal if you need to pay property tax, PST, or other provincial fees</li>
                                <li><strong>Optional</strong> – Contact an accountant if your income sources are complex (like foreign income or freelance work)</li>
                            </ul>
                        </div>
                    `;
                    addMessage(checklistHtml, 'bot');

                    setTimeout(() => {
                        addMessage("Need help finding a tax advisor or trusted accountant?", 'bot', {
                            options: [
                                { text: "Yes, show me options", action: "show_advisors" },
                                { text: "No, I'll try it myself", action: "try_myself" }
                            ]
                        });
                    }, 1500);
                }, 800);
            },

            no_checklist: () => {
                addMessage("No, I'm good for now", 'user');
                setTimeout(() => {
                    addMessage("Perfect! Remember, I'm here if you need any help. Good luck with your tax filing! 🍀", 'bot');
                    // 重新启用输入控件
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            show_advisors: () => {
                addMessage("Yes, show me options", 'user');
                setTimeout(() => {
                    addMessage("Here are some resources to find qualified tax professionals in BC:\n\n• CPA Canada directory for certified accountants\n• H&R Block for walk-in tax services\n• Local community volunteer tax clinics (for simple returns)\n\nWould you like specific recommendations based on your location?", 'bot');
                    // 这里可以添加更多选项，或者结束流程
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            try_myself: () => {
                addMessage("No, I'll try it myself", 'user');
                setTimeout(() => {
                    addMessage("That's great! You've got all the information you need. Feel free to ask if you have any questions along the way. Good luck!", 'bot');
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            show_tools: () => {
                addMessage("Yes, show me options", 'user');
                setTimeout(() => {
                    addMessage("Here are some free tax filing tools:\n\n• Wealthsimple Tax (formerly SimpleTax) - Free for all income levels\n• TurboTax Free - For simple returns\n• StudioTax - Free certified software\n• GenuTax - Another free option\n\nAll of these are CRA-certified. Would you like help choosing one?", 'bot');
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            figure_out: () => {
                addMessage("I'll figure it out myself", 'user');
                setTimeout(() => {
                    addMessage("No problem! When you're ready, you can find CRA-certified tax software on the CRA website. Let me know if you need any other help!", 'bot');
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            explain_tools: () => {
                addMessage("Yes, please explain", 'user');
                setTimeout(() => {
                    addMessage("Tax software walks you through your tax return step by step. You'll enter information from your T4 (employment income), receipts for deductions, and answer simple questions. The software calculates everything and produces the forms you need to submit to CRA. It's much easier than doing it by hand!", 'bot');
                    setTimeout(() => {
                        addMessage("Would you like me to recommend some free tax software options?", 'bot', {
                            options: [
                                { text: "Yes, show me options", action: "show_tools" },
                                { text: "I'll look into it myself", action: "figure_out" }
                            ]
                        });
                    }, 1000);
                }, 800);
            },

            research_own: () => {
                addMessage("I'll research on my own", 'user');
                setTimeout(() => {
                    addMessage("That's perfectly fine! Take your time to explore the options. I'm here if you have any questions!", 'bot');
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            // Tax flow action handlers
            propertyTaxOnly: () => {
                addMessage("Just show me property tax info", 'user');
                setTimeout(() => {
                    addMessage("I'll help you with property tax information. Property tax in BC is managed at the municipal level. Here's what you need to know:\n\n• Payment can be made online through your municipality's website\n• Most municipalities accept payment via online banking\n• Deadlines are typically July 2nd (to avoid penalty)\n• You may be eligible for the Home Owner Grant\n\nWould you like me to help you find your municipality's tax payment portal?", 'bot');
                    // 重新启用输入控件
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            justAnswer: () => {
                addMessage("No, just answer my question", 'user');
                setTimeout(() => {
                    addMessage("Of course! Please let me know what specific tax information you're looking for, and I'll do my best to help.", 'bot');
                    // 重新启用输入控件
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            // 新增的动作处理
            show_filing_form: () => {
                addMessage("📝 Fill out a form for customized guidance", 'user');
                setTimeout(() => {
                    // 首先显示隐私确认信息
                    addMessage(`Before we proceed with personalized guidance, I need to inform you about how we'll handle your information:

<div class="privacy-notice">
    <div class="privacy-notice-title">
        <span>🔒</span> Privacy & Information Use Notice
    </div>
    <div class="privacy-notice-content">
        <strong>How we'll use your information:</strong>
        <ul>
            <li>Your personal information will be used solely to provide customized tax guidance during this chat session</li>
            <li>We do not store or share your information with third parties</li>
            <li>The information is processed securely and deleted after your session ends</li>
            <li>You can opt out at any time by choosing general guidance instead</li>
        </ul>
        
        <strong>What we'll ask for:</strong>
        <ul>
            <li>Basic filing information (status, province)</li>
            <li>Types of income sources (no amounts)</li>
            <li>Relevant tax situations (homeowner, student, etc.)</li>
        </ul>
    </div>
    <div class="privacy-checkbox-container" onclick="togglePrivacyConsent()">
        <input type="checkbox" id="privacyConsent" class="privacy-checkbox">
        <label for="privacyConsent" class="privacy-checkbox-label">
            I understand and agree to the use of my information for personalized tax guidance
        </label>
    </div>
</div>

Do you agree to proceed with personalized guidance?`, 'bot', {
                        options: [
                            { text: "Yes, I agree - Continue to form", action: "privacy_agreed" },
                            { text: "No, use general guidance instead", action: "privacy_declined" }
                        ]
                    });
                }, 800);
            },

            privacy_agreed: () => {
                const consentCheckbox = document.getElementById('privacyConsent');
                if (!consentCheckbox || !consentCheckbox.checked) {
                    addMessage("Yes, I agree - Continue to form", 'user');
                    setTimeout(() => {
                        addMessage("Please check the acknowledgement box above to confirm you've read and understood how we'll use your information.", 'bot', {
                            options: [
                                { text: "I've checked the box - Continue", action: "privacy_agreed" },
                                { text: "Use general guidance instead", action: "privacy_declined" }
                            ]
                        });
                    }, 800);
                    return;
                }
                
                addMessage("Yes, I agree - Continue to form", 'user');
                setTimeout(() => {
                    addMessage("Thank you for your consent. Let's proceed with the personalized tax filing form.", 'bot');
                    setTimeout(() => {
                        setInputControlsEnabled(true); // 暂时启用输入
                        showFilingForm();
                    }, 1000);
                }, 800);
            },

            privacy_declined: () => {
                addMessage("No, use general guidance instead", 'user');
                setTimeout(() => {
                    addMessage("No problem! I'll provide you with general tax filing guidance without collecting any personal information.", 'bot');
                    setTimeout(() => {
                        taxFlowActive = true;
                        taxFlowStep = 1;
                        disableAllOptions();
                        setInputControlsEnabled(false);
                        taxFlowConversation.start();
                    }, 1000);
                }, 800);
            },

            general_guidance: () => {
                taxFlowActive = true;
                taxFlowStep = 1;
                disableAllOptions();
                setInputControlsEnabled(false);
                taxFlowConversation.start();
            },

            // 自定义流程的后续动作
            detailed_guide: () => {
                addMessage("Walk me through the filing process step-by-step", 'user');
                setTimeout(() => {
                    addMessage("Perfect! Let's start with Step 1: Gathering your documents...", 'bot');
                    // 继续详细指导...
                    setTimeout(() => {
                        setInputControlsEnabled(true);
                        taxFlowActive = false;
                    }, 1000);
                }, 800);
            },

            software_recommendations: () => {
                addMessage("Show me tax software recommendations", 'user');
                setTimeout(() => {
                    addMessage("Based on your profile, here are my top recommendations:\n\n1. **Wealthsimple Tax** - Free and easy to use\n2. **TurboTax** - Great for complex returns\n3. **StudioTax** - Free certified software\n\nWould you like more details about any of these?", 'bot');
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            estimate_refund: () => {
                addMessage("Help me estimate my refund/payment", 'user');
                setTimeout(() => {
                    addMessage("I can help estimate your refund! I'll need some income information. Would you like to use our refund calculator?", 'bot');
                    setInputControlsEnabled(true);
                    taxFlowActive = false;
                }, 800);
            },

            find_credits: () => {
                addMessage("Find tax credits I might be missing", 'user');
                setTimeout(() => {
                    addMessage("Let me check for commonly missed tax credits based on your profile...", 'bot');
                    setTimeout(() => {
                        addMessage("Here are tax credits you might be eligible for:\n\n• Climate Action Tax Credit\n• GST/HST Credit\n• Medical Expense Tax Credit\n• Working Income Tax Benefit\n\nWould you like details on any of these?", 'bot');
                        setInputControlsEnabled(true);
                        taxFlowActive = false;
                    }, 1000);
                }, 800);
            }
        };

        // Helper function to disable all option buttons
        function disableAllOptions() {
            document.querySelectorAll('.option-button').forEach(button => {
                button.disabled = true;
            });
        }

        function togglePanel() {
            const panel = document.getElementById('chatPanel');
            isPanelExpanded = !isPanelExpanded;

            if (isPanelExpanded) {
                panel.classList.add('expanded');
                if (!inChatMode) {
                    // Show home view when expanding
                    document.getElementById('panelContent').classList.remove('chat-active');
                }
            } else {
                panel.classList.remove('expanded');
            }
        }

        function enterChatMode() {
            const panelContent = document.getElementById('panelContent');
            if (inChatMode) return;

            inChatMode = true;
            panelContent.classList.add('chat-active');
            
            // 启用End Chat按钮
            const endBtn = document.getElementById('endBtn');
            if (endBtn) {
                endBtn.classList.remove('disabled');
            }

            // Clear any existing messages first
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';

            // Add initial bot message WITHOUT tax filing button
            addMessage("Hello! I am here to help you with BC taxes and benefits. What would you like to know?", 'bot');

            // If panel is not expanded, expand it
            if (!isPanelExpanded) {
                togglePanel();
            }
        }

        function startTaxFlow() {
            // 显示选项让用户选择
            addMessage("🗓️ Guide me through tax filing", 'user');
            setTimeout(() => {
                addMessage("I can help you with tax filing! Would you like to:", 'bot', {
                    options: [
                        { text: "📝 Fill out a form for customized guidance", action: "show_filing_form" },
                        { text: "💬 Continue with general guidance", action: "general_guidance" }
                    ]
                });
            }, 800);
        }

        function selectAction(action) {
            enterChatMode();
            setTimeout(() => {
                addMessage('I would like to ' + action, 'user');

                // Check if this is property tax related
                if (action.toLowerCase().includes('pay property tax')) {
                    setTimeout(() => {
                        addMessage("I see you want to pay property tax. I can help you with that! Would you like me to guide you through the complete tax filing process, which includes property tax?", 'bot', {
                            options: [
                                { text: "🗓️ Guide me through tax filing", action: "startTaxFlow" },
                                { text: "Just show me property tax info", action: "propertyTaxOnly" }
                            ]
                        });
                    }, 1000);
                } else {
                    setTimeout(() => {
                        addMessage('I will help you with "' + action + '". Let me guide you through the process...', 'bot');
                    }, 1000);
                }
            }, 300);
        }

        function toggleVoiceRecording() {
            const voiceButton = document.getElementById('mainVoiceBtn');
            isRecording = !isRecording;

            if (isRecording) {
                voiceButton.classList.add('recording');
                setTimeout(() => {
                    voiceButton.classList.remove('recording');
                    isRecording = false;
                    // Get the text from the input field
                    const mainInput = document.getElementById('mainInputField');
                    const inputText = mainInput.value || 'I want to pay my property tax';
                    handleMainInputSubmit(inputText);
                }, 3000);
            } else {
                voiceButton.classList.remove('recording');
            }
        }

        function handleMainInputSubmit(message) {
            const mainInput = document.getElementById('mainInputField');

            if (!message) {
                message = mainInput.value.trim();
            }

            if (message) {
                enterChatMode();
                mainInput.value = '';

                setTimeout(() => {
                    addMessage(message, 'user');

                    // Check for property tax keywords
                    const propertyTaxKeywords = ['property tax', 'pay property', 'property payment', 'house tax', 'home tax'];
                    const generalTaxKeywords = ['tax', 'filing', 'file', 'submit', 'deadline', 'cra', 'return'];

                    const mentionsPropertyTax = propertyTaxKeywords.some(keyword =>
                        message.toLowerCase().includes(keyword)
                    );

                    const mentionsTax = generalTaxKeywords.some(keyword =>
                        message.toLowerCase().includes(keyword)
                    );

                    setTimeout(() => {
                        if (mentionsPropertyTax) {
                            // User specifically mentioned property tax
                            addMessage("I see you want to pay property tax. I can help you with that! Would you like me to guide you through the complete tax filing process, which includes property tax?", 'bot', {
                                options: [
                                    { text: "🗓️ Guide me through tax filing", action: "startTaxFlow" },
                                    { text: "Just show me property tax info", action: "propertyTaxOnly" }
                                ]
                            });
                        } else if (mentionsTax && !taxFlowActive) {
                            // User mentioned tax but not specifically property tax
                            addMessage("I see you're asking about taxes. Would you like me to guide you through the tax filing process?", 'bot', {
                                options: [
                                    { text: "🗓️ Guide me through tax filing", action: "startTaxFlow" },
                                    { text: "No, just answer my question", action: "justAnswer" }
                                ]
                            });
                        } else {
                            addMessage('I understand you are asking about: "' + message + '". Let me help you with that.', 'bot');
                        }
                    }, 1000);
                }, 300);
            }
        }

        function addMessage(content, sender, options = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const bubbleDiv = document.createElement('div');
            bubbleDiv.className = 'message-bubble';

            // Handle HTML content for bot messages
            if (sender === 'bot' && content.includes('<')) {
                bubbleDiv.innerHTML = content;
            } else {
                // Convert newlines to <br> tags for proper display
                const htmlContent = content.replace(/\n/g, '<br>');
                bubbleDiv.innerHTML = htmlContent;
            }

            // Add options if provided
            if (options && options.options) {
                // 如果有选项按钮，禁用输入控件
                if (!taxFlowActive) {
                    setInputControlsEnabled(false);
                }
                
                const optionsDiv = document.createElement('div');
                optionsDiv.className = 'message-options';

                options.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = option.text;
                    button.onclick = () => {
                        disableAllOptions();
                        
                        // 如果不是开始税务流程，重新启用输入控件
                        if (option.action !== 'startTaxFlow' && !taxFlowActive) {
                            setInputControlsEnabled(true);
                        }
                        
                        if (option.action === 'startTaxFlow') {
                            startTaxFlow();
                        } else if (taxFlowConversation[option.action]) {
                            taxFlowConversation[option.action]();
                        } else {
                            addMessage(option.text, 'user');
                            setTimeout(() => {
                                addMessage('I will help you with that.', 'bot');
                                // 重新启用输入控件
                                setInputControlsEnabled(true);
                            }, 800);
                        }
                    };
                    optionsDiv.appendChild(button);
                });

                bubbleDiv.appendChild(optionsDiv);
            }

            messageDiv.appendChild(bubbleDiv);
            messagesContainer.appendChild(messageDiv);

            // Force scroll to bottom with multiple attempts
            const scrollToBottom = () => {
                const panel = document.getElementById('panelContent');
                if (panel) {
                    panel.scrollTop = panel.scrollHeight;
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            };

            // Immediate scroll
            scrollToBottom();

            // Scroll after DOM update
            requestAnimationFrame(() => {
                scrollToBottom();
            });

            // Scroll after content renders
            setTimeout(scrollToBottom, 100);

            // Extra scroll for complex content
            if (options || content.includes('<div')) {
                setTimeout(scrollToBottom, 300);
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                handleMainInputSubmit();
            }
        }

        // Function to end chat and return to home
        function endChat() {
            const saveDialog = document.getElementById('saveDialogOverlay');
            saveDialog.classList.add('show');
        }

        // Function to save transcript
        function saveTranscript() {
            const messages = document.querySelectorAll('.message');
            let transcript = 'BC Tax Assistant - Chat Transcript\n';
            transcript += 'Date: ' + new Date().toLocaleString() + '\n';
            transcript += '================================\n\n';

            messages.forEach(msg => {
                const sender = msg.classList.contains('user') ? 'You' : 'AskBC';
                const text = msg.querySelector('.message-bubble').innerText;
                transcript += `${sender}: ${text}\n\n`;
            });

            // Create and download file
            const blob = new Blob([transcript], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'AskBC_Chat_Transcript_' + new Date().toISOString().slice(0, 10) + '.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            // Close dialog and return to home
            closeSaveDialog();
            returnToHome();
        }

        // Function to close save dialog
        function closeSaveDialog() {
            const saveDialog = document.getElementById('saveDialogOverlay');
            saveDialog.classList.remove('show');
        }

        // Function to return to home view
        function returnToHome() {
            const panelContent = document.getElementById('panelContent');
            panelContent.classList.remove('chat-active');
            inChatMode = false;
            taxFlowActive = false; // 重置税务流程状态
            
            // 禁用End Chat按钮
            const endBtn = document.getElementById('endBtn');
            if (endBtn) {
                endBtn.classList.add('disabled');
            }
            
            // 重新启用输入控件
            setInputControlsEnabled(true);

            // Note: Chat messages are preserved, not cleared
        }

        // 添加表单相关的函数
        function showFilingForm() {
            const formOverlay = document.getElementById('filingFormOverlay');
            formOverlay.classList.add('show');
        }

        function closeFilingForm() {
            const formOverlay = document.getElementById('filingFormOverlay');
            formOverlay.classList.remove('show');
        }

        // 添加隐私同意复选框切换函数
        function togglePrivacyConsent() {
            const checkbox = document.getElementById('privacyConsent');
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
            }
        }

        // 使函数在全局作用域可用
        window.togglePrivacyConsent = togglePrivacyConsent;
        window.closeFilingForm = closeFilingForm;

        // 自定义税务流程
        function startCustomizedTaxFlow(userData) {
            taxFlowActive = true;
            disableAllOptions();
            setInputControlsEnabled(false);
            
            // 生成个性化的欢迎消息
            let welcomeMessage = "Thanks for providing your information! Based on what you've told me, I'll create a customized tax filing guide for you.\n\n";
            
            // 根据用户数据添加个性化内容
            const statusMap = {
                'single': 'Single',
                'married': 'Married/Common-law',
                'separated': 'Separated',
                'widowed': 'Widowed'
            };
            
            welcomeMessage += `📍 Filing from: ${userData.province === 'BC' ? 'British Columbia' : 'Another province'}\n`;
            welcomeMessage += `👤 Filing status: ${statusMap[userData.filingStatus] || userData.filingStatus}\n`;
            
            if (userData.firstTime === 'yes') {
                welcomeMessage += `🌟 First time filing - I'll make sure to explain everything clearly!\n`;
            }
            
            addMessage(welcomeMessage, 'bot');
            
            setTimeout(() => {
                // 根据收入来源提供建议
                if (userData.incomeSources && userData.incomeSources.length > 0) {
                    let incomeMessage = "Based on your income sources, you'll need these forms:\n\n";
                    
                    if (userData.incomeSources.includes('employment')) {
                        incomeMessage += "• T4 slips from your employer(s)\n";
                    }
                    if (userData.incomeSources.includes('selfEmployed')) {
                        incomeMessage += "• Business income records and receipts (T2125)\n";
                    }
                    if (userData.incomeSources.includes('investment')) {
                        incomeMessage += "• T5 slips for investment income\n";
                    }
                    if (userData.incomeSources.includes('rental')) {
                        incomeMessage += "• Rental income and expense records (T776)\n";
                    }
                    if (userData.incomeSources.includes('benefits')) {
                        incomeMessage += "• T4E (EI), T4A(P) (pension), or other benefit slips\n";
                    }
                    if (userData.incomeSources.includes('other')) {
                        incomeMessage += "• Documentation for other income sources\n";
                    }
                    
                    addMessage(incomeMessage, 'bot');
                } else {
                    addMessage("I notice you didn't select any income sources. Let's make sure we cover all your income types to avoid missing any important forms.", 'bot');
                }
                
                setTimeout(() => {
                    // 根据特殊情况提供额外建议
                    if (userData.specialSituations && userData.specialSituations.length > 0) {
                        let specialMessage = "I noticed you have some special situations that could help reduce your taxes:\n\n";
                        
                        if (userData.specialSituations.includes('homeowner')) {
                            specialMessage += "🏠 **As a homeowner**, you may be eligible for:\n";
                            specialMessage += "   • Home Owner Grant (if in BC)\n";
                            specialMessage += "   • First-time home buyers' tax credit\n";
                            specialMessage += "   • Home accessibility tax credit\n\n";
                        }
                        if (userData.specialSituations.includes('children')) {
                            specialMessage += "👨‍👩‍👧‍👦 **With dependent children**, don't forget:\n";
                            specialMessage += "   • Canada Child Benefit (non-taxable)\n";
                            specialMessage += "   • Child care expense deductions\n";
                            specialMessage += "   • Children's fitness/arts tax credits\n\n";
                        }
                        if (userData.specialSituations.includes('student')) {
                            specialMessage += "🎓 **As a student**, you can claim:\n";
                            specialMessage += "   • Tuition tax credits (T2202)\n";
                            specialMessage += "   • Student loan interest\n";
                            specialMessage += "   • Moving expenses for school\n\n";
                        }
                        if (userData.specialSituations.includes('medical')) {
                            specialMessage += "🏥 **For medical expenses**:\n";
                            specialMessage += "   • Keep all receipts for expenses over 3% of income\n";
                            specialMessage += "   • Include travel for medical treatment\n";
                            specialMessage += "   • Don't forget dental and prescription costs\n\n";
                        }
                        if (userData.specialSituations.includes('charitable')) {
                            specialMessage += "❤️ **For charitable donations**:\n";
                            specialMessage += "   • Ensure you have official receipts\n";
                            specialMessage += "   • First $200 gets 15% credit\n";
                            specialMessage += "   • Amounts over $200 get 29% credit\n\n";
                        }
                        
                        addMessage(specialMessage, 'bot');
                    }
                    
                    setTimeout(() => {
                        // 提供下一步选项
                        addMessage("Based on your profile, what would you like help with next?", 'bot', {
                            options: [
                                { text: "Walk me through the filing process step-by-step", action: "detailed_guide" },
                                { text: "Show me tax software recommendations", action: "software_recommendations" },
                                { text: "Help me estimate my refund/payment", action: "estimate_refund" },
                                { text: "Find tax credits I might be missing", action: "find_credits" }
                            ]
                        });
                    }, 1500);
                }, 2000);
            }, 1500);
        }

        // Initialize after DOM is loaded
        document.addEventListener('DOMContentLoaded', function () {
            // Event listeners
            document.getElementById('expandBtn').addEventListener('click', togglePanel);
            document.getElementById('panelCloseBtn').addEventListener('click', togglePanel);
            document.getElementById('mainVoiceBtn').addEventListener('click', toggleVoiceRecording);
            document.getElementById('mainSendBtn').addEventListener('click', () => handleMainInputSubmit());

            // End chat and save dialog listeners
            document.getElementById('endBtn').addEventListener('click', endChat);
            document.getElementById('saveTranscriptBtn').addEventListener('click', saveTranscript);
            document.getElementById('dontSaveBtn').addEventListener('click', () => {
                closeSaveDialog();
                returnToHome();
            });

            // Close dialog on overlay click
            document.getElementById('saveDialogOverlay').addEventListener('click', (e) => {
                if (e.target.id === 'saveDialogOverlay') {
                    closeSaveDialog();
                }
            });

            // Main input field
            const mainInput = document.getElementById('mainInputField');
            if (mainInput) {
                mainInput.addEventListener('keypress', handleKeyPress);
                mainInput.addEventListener('focus', () => {
                    if (!isPanelExpanded) {
                        togglePanel();
                    }
                });
            }

            // Font size slider functionality
            const fontSizes = ['small', 'medium', 'large', 'xlarge'];
            let currentFontSizeIndex = 1; // Default to medium

            const sliderBox = document.getElementById('sliderBox');
            const sliderHandle = document.getElementById('sliderHandle');
            const sliderFill = document.getElementById('sliderFill');

            function updateFontSize(index) {
                if (index < 0) index = 0;
                if (index >= fontSizes.length) index = fontSizes.length - 1;

                currentFontSizeIndex = index;
                const size = fontSizes[index];
                const chatPanel = document.getElementById('chatPanel');

                // Remove all size classes
                chatPanel.classList.remove('font-size-small', 'font-size-medium', 'font-size-large', 'font-size-xlarge');

                // Add selected size class
                chatPanel.classList.add(`font-size-${size}`);

                // Update slider position
                const percentage = (index / (fontSizes.length - 1)) * 100;
                sliderHandle.style.left = percentage + '%';
                sliderFill.style.width = percentage + '%';

                // Save preference
                localStorage.setItem('askbc-font-size', size);
            }

            // Slider click handler
            if (sliderBox) {
                sliderBox.addEventListener('click', function (e) {
                    const rect = this.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const percentage = x / rect.width;
                    const index = Math.round(percentage * (fontSizes.length - 1));
                    updateFontSize(index);
                });
            }

            // Load saved font size
            const savedFontSize = localStorage.getItem('askbc-font-size');
            if (savedFontSize) {
                const index = fontSizes.indexOf(savedFontSize);
                if (index !== -1) {
                    updateFontSize(index);
                }
            } else {
                updateFontSize(1); // Initialize default position
            }

            // Download button
            const downloadBtn = document.getElementById('downloadBtn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', saveTranscript);
            }

            // 初始化End Chat按钮为禁用状态
            const endBtn = document.getElementById('endBtn');
            if (endBtn) {
                endBtn.classList.add('disabled');
            }

            // Action cards
            document.querySelectorAll('.action-card').forEach((card, index) => {
                const actions = ['Pay Property Tax', 'View Tax Bill', 'Log in to eTaxBC', 'Check Due Date'];
                card.addEventListener('click', function (e) {
                    e.stopPropagation();
                    selectAction(actions[index]);
                });
            });

            // Popular topics buttons
            document.querySelectorAll('.panel-content button').forEach(button => {
                if (button.textContent.includes('Homeowner Grant') ||
                    button.textContent.includes('Tax Deferment') ||
                    button.textContent.includes('Assessment')) {
                    button.addEventListener('click', function () {
                        const topic = this.textContent.trim();
                        enterChatMode();
                        setTimeout(() => {
                            addMessage(`Tell me about ${topic}`, 'user');
                            setTimeout(() => {
                                addMessage(`I'll help you understand ${topic}. This is an important benefit for BC residents...`, 'bot');
                            }, 1000);
                        }, 300);
                    });
                }
            });

            // 处理表单提交
            document.getElementById('filingForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 收集表单数据
                const formData = new FormData(this);
                const filingData = {
                    filingStatus: formData.get('filingStatus'),
                    province: formData.get('province'),
                    firstTime: formData.get('firstTime'),
                    incomeSources: formData.getAll('incomeSources'),
                    specialSituations: formData.getAll('specialSituations')
                };
                
                // 关闭表单
                closeFilingForm();
                
                // 确保在聊天模式中
                if (!inChatMode) {
                    enterChatMode();
                }
                
                // 开始自定义的税务流程
                setTimeout(() => {
                    startCustomizedTaxFlow(filingData);
                }, 500);
            });

            // 点击表单外部关闭
            document.getElementById('filingFormOverlay').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeFilingForm();
                }
            });
        });
    </script>
</body>

</html>